{% extends "base.html" %}
{% load l10n %}
{% load i18n %}
{% block title %}{% trans "Map" %}{% endblock %}
{% block head %}{% trans "Map" %}{% endblock %}
{% block content %}
  <script type="text/javascript">
      window.m_listener = {
          markerOver: function() { this.openInfoWindow(); },
          markerOut: function() { this.closeInfoWindow(); },
          markerClick: function(e) {
            var location_id = $(this.getInfoWindow().content).attr('id');
            show_info_modal(location_id);
          },
      };      

      function show_info_modal(location_id) {
        $.post("/find_location_by_id/", 
          { id: location_id }, 
          function(data) {
            $('#info_modal_label').text(data.place_name + ' (' + data.info +'/'+ data.status + ')');
            $('#contact_name').text(data.first_name + " " + data.last_name);
            $('#email').text(data.email);
            $('#phone_number').text(data.phone_number);
            $('#address').text(data.address);
            $('#city').text(data.city + ", " + data.country);
            $('#activities').text(data.activities);
            $('#additional_info').text(data.additional_info);    
            $('#approved').text(data.approved);            
            $('#info_modal').modal({backdrop:true, keyboard:true});
            if (data.relation == '') {
              $('#td_id_relation').hide();
            } else {
              $('#relation').text(data.relation);
            }
          });
      }

      function resize_containers() {
        var gmap = $('div.gmap');            
        var width = $('#nav_bar').is(':visible') ? $('#map_container').width() : $('.row-fluid').width();        
        var height = $('#map_container').height();
        var gap = $('#footer').position().top - ($('#map_container').position().top + height);

        height += gap - 30;
        
        gmap.width(width);        
        $('div.gmap>div').width(width);
        $('div.gmap>img').width(width);        
        
        // set maximum height
        height = height > 600 ? 600 : height;        
        gmap.height(height);        
        $('div.gmap>div').height(height);
        $('div.gmap>img').height(height);                
      }

      function resize_map() {
        resize_containers();
        var gmap = $('div.gmap');
        google.maps.event.trigger(gmap.getMap(), 'resize');
      }

      $(document).ready(function() {
        $.waypoints.settings.scrollThrottle = 30;
        $('div.gmap').waypoint(function(e, direction) {
          $(this).toggleClass('sticky', direction == "down");
          e.stopPropagation();
        });
        
        $("a.location").click(function(event) {
          event.preventDefault();
          move_to($(this).attr('lat'), $(this).attr('lng'));
          if ($(this).parent().attr('class') == 'active') {
            show_info_modal($(this).attr('id'));
          } else {
            $('li.active').toggleClass('active');
            $(this).parent().attr('class', 'active');
          }
        });        

        resize_containers();

        $(window).resize(function() {
          resize_map();
        });
        
      });
      
      function move_to(lat, lng) {
        var gmap = $('div.gmap:visible');        
        var point = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
        gmap.getMap().setZoom(16);
        gmap.getMap().panTo(point);
      }

  </script>

  <div id="info_modal" class="modal hide fade" tabindex="-1" role="dialog" 
    aria-labelledby="info_modal_label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 id="info_modal_label"></h3>
    </div>    
    <div class="modal-body">
      <table class="table" style="border-color: blue !important;">
        <tbody>
          <tr>
            <td>
              <strong>{% trans 'Contact name' %}</strong>
              <p id="contact_name"> </p>  
            </td>
            <td>
              <strong>{% trans 'Phone number' %}</strong>
              <p id="phone_number"> </p>            
            </td>
            <td>
              <strong>{% trans 'E-mail' %}</strong>
              <p id="email"> </p>            
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <strong>{% trans 'Address' %}</strong>
              <p id="address"> </p>            
            </td>
            <td>
              <strong>{% trans 'City/Country' %}</strong>
              <p id="city"> </p>            
            </td>            
          </tr>
          <tr>
            <td colspan="3">
              <strong>{% trans 'Activities' %}</strong>
              <p id="activities"> </p>            
            </td>            
          </tr>
          <tr>
            <td colspan="2">
              <strong>{% trans 'Additional information' %}</strong>
              <p id="additional_info"> </p>            
            </td>            
            <td id="td_id_relation">
              <strong>{% trans 'Organization relationship' %}</strong>
              <p id="relation"> </p>            
            </td>            
          </tr>          
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Close" %}</button>
    </div>
  </div>
    
  <div class="row-fluid">
    <div id="nav_bar" class="span3 hidden-phone hidden-tablet">
      <ul class="nav nav-list bs-sidenav">   
        <li class="nav-header"><h4>Total ({{total}})</h4></li>             
        {% for nav in nav_list %}
          {% if nav.type == 'header' %}
            <li class="nav-header">{{ nav.value }}</li>
          {% else %}
            <li><a id="{{nav.value.id}}" lat="{{nav.value.latitude}}" lng="{{nav.value.longitude}}" 
              class="location" href="#">{{ nav.value.place_name }}, {{ nav.value.city }}</a></li>
          {% endif %}
        {% endfor %}        
      </ul>      
    </div>    
    <div id="map_container" class="span9 span12-tablet">
      {{ form.gmap }}
      {{ form.media.js }}        
    </div>
  </div>
  
{% endblock %}

{% block footer %}{% include "footer.html" %}{% endblock %}